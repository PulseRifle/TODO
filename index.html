<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets TO-DO List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #f7fafc;
        }
        .tab-active { 
            border-bottom: 2px solid #6366F1;
            color: #4F46E5;
            font-weight: 700; 
        }
        .calendar-day { 
            min-height: 90px;
            font-size: 0.8rem;
            transition: background-color 0.2s ease;
        }
        .event { 
            font-size: 0.75rem; 
            padding: 2px 5px; 
            border-radius: 6px; 
            margin-bottom: 2px; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
            border: 1px solid transparent;
        }
        .is-resting-day {
            background-color: #f1f5f9 !important;
        }
        .holiday-text {
            font-size: 0.7rem;
            color: #EF4444;
            font-weight: 500;
        }
        
        /* Custom Colors based on category - Refined Palette */
        .event-점심 { background-color: #FEF3C7; color: #92400E; border-color: #FDE68A; } /* Amber */
        .event-저녁 { background-color: #FFEDD5; color: #9A3412; border-color: #FED7AA; } /* Orange */
        .event-봉사활동 { background-color: #D9F99D; color: #3F6212; border-color: #BEF264; } /* Lime */
        .event-회사행사 { background-color: #E2E8F0; color: #334155; border-color: #CBD5E1; } /* Slate */
        .event-기타이벤트 { background-color: #E0E7FF; color: #3730A3; border-color: #C7D2FE; } /* Indigo */
        .event-회의 { background-color: #CFFAFE; color: #0891B2; border-color: #A5F3FC; } /* Cyan */
        .event-휴가 { background-color: #E5E7EB; color: #4B5563; border-color: #D1D5DB; } /* Gray for vacation event */
        
        #dataTable th { cursor: pointer; }
        #dataTable th:hover { background-color: #f1f5f9; }

        /* Loading Spinner */
        #loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6366F1;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-6">
    <div id="loader"></div>
    <div class="container mx-auto max-w-7xl bg-white rounded-xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-6 pb-4 border-b">
             <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 002-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">TO-DO List</h1>
            </div>
            <button id="addNewBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg transition-all duration-300 shadow hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                신규 등록
            </button>
        </div>

        <!-- Tabs -->
        <div class="border-b border-gray-200">
            <nav class="flex space-x-6" aria-label="Tabs">
                <button id="calendarTab" class="py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 tab-active">캘린더</button>
                <button id="statusTab" class="py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">현황</button>
            </nav>
        </div>

        <!-- Calendar View -->
        <div id="calendarView">
            <div class="p-4 bg-gray-50 rounded-b-lg">
                <!-- Calendar Controls -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6 p-4 bg-white rounded-lg border">
                     <div>
                        <label for="yearSelect" class="block text-sm font-medium text-gray-700 mb-2">연도</label>
                        <select id="yearSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 p-2.5 bg-gray-50 focus:bg-white"></select>
                    </div>
                    <div>
                        <label for="monthSelect" class="block text-sm font-medium text-gray-700 mb-2">월</label>
                        <select id="monthSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 p-2.5 bg-gray-50 focus:bg-white">
                            <option value="1">1월</option><option value="2">2월</option><option value="3">3월</option><option value="4">4월</option>
                            <option value="5">5월</option><option value="6">6월</option><option value="7">7월</option><option value="8">8월</option>
                            <option value="9">9월</option><option value="10">10월</option><option value="11">11월</option><option value="12">12월</option>
                        </select>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">대분류</label>
                        <div id="categoryFilterContainer" class="flex flex-wrap gap-x-4 gap-y-2 text-sm pt-2"></div>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">중요도</label>
                        <div id="priorityFilterContainer" class="flex flex-wrap gap-x-4 gap-y-2 text-sm pt-2"></div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">기준 날짜</label>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center"><input type="radio" name="dateType" value="등록일자" class="date-type-filter h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked> <span class="ml-2">등록일자</span></label>
                            <label class="flex items-center"><input type="radio" name="dateType" value="마감일자" class="date-type-filter h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-2">마감일자</span></label>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">반복 일정</label>
                         <div id="calendarRepeatFilterContainer" class="flex flex-wrap gap-x-4 gap-y-2 text-sm"></div>
                    </div>
                </div>

                <!-- Calendar Navigation -->
                <div class="flex justify-center items-center mb-4 space-x-4">
                    <button id="prevMonth" class="bg-white border rounded-lg px-4 py-2 text-sm font-medium hover:bg-gray-100 transition-colors">이전 달</button>
                    <button id="nextMonth" class="bg-white border rounded-lg px-4 py-2 text-sm font-medium hover:bg-gray-100 transition-colors">다음 달</button>
                </div>
                
                 <!-- 3-Month Calendar Container -->
                <div id="multiCalendarContainer" class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Calendar 1 -->
                    <div id="calendarContainer1" class="border rounded-lg bg-white p-3">
                        <h2 class="calendar-title-text text-lg font-semibold text-center text-gray-700 mb-2"></h2>
                        <div class="grid grid-cols-7 text-center text-xs font-bold border-b pb-1 mb-1 text-gray-500">
                            <div class="text-red-500">일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div class="text-blue-500">토</div>
                        </div>
                        <div class="calendar-grid grid grid-cols-7 gap-px"></div>
                    </div>
                    <!-- Calendar 2 -->
                    <div id="calendarContainer2" class="border rounded-lg bg-white p-3">
                        <h2 class="calendar-title-text text-lg font-semibold text-center text-gray-700 mb-2"></h2>
                        <div class="grid grid-cols-7 text-center text-xs font-bold border-b pb-1 mb-1 text-gray-500">
                             <div class="text-red-500">일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div class="text-blue-500">토</div>
                        </div>
                        <div class="calendar-grid grid grid-cols-7 gap-px"></div>
                    </div>
                    <!-- Calendar 3 -->
                    <div id="calendarContainer3" class="border rounded-lg bg-white p-3">
                        <h2 class="calendar-title-text text-lg font-semibold text-center text-gray-700 mb-2"></h2>
                        <div class="grid grid-cols-7 text-center text-xs font-bold border-b pb-1 mb-1 text-gray-500">
                             <div class="text-red-500">일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div class="text-blue-500">토</div>
                        </div>
                        <div class="calendar-grid grid grid-cols-7 gap-px"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status View -->
        <div id="statusView" class="hidden">
             <div class="p-4 bg-gray-50 rounded-b-lg">
                 <div class="mb-4 p-4 bg-white rounded-lg border grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">월 선택 필터</label>
                        <div id="monthFilterContainer" class="flex flex-wrap gap-x-4 gap-y-2 text-sm"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">반복 일정</label>
                         <div id="statusRepeatFilterContainer" class="flex flex-wrap gap-x-4 gap-y-2 text-sm"></div>
                    </div>
                    <div class="md:col-span-3 flex justify-end">
                        <button id="deleteSelectedBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-5 rounded-lg transition-all duration-300 shadow hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                            선택 삭제
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="dataTable" class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead class="bg-gray-100">
                            <tr>
                                <!-- Headers will be populated by JS -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
             </div>
        </div>
    </div>

    <!-- Modal for New/Edit -->
    <div id="formModal" class="fixed inset-0 bg-gray-800 bg-opacity-60 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-6 border w-full max-w-2xl shadow-2xl rounded-lg bg-white">
            <div class="flex justify-between items-center pb-4 border-b">
                <p class="text-2xl font-bold text-gray-800">일정 등록/수정</p>
                <button id="closeModal" class="cursor-pointer z-50 text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            <form id="todoForm" class="space-y-4 pt-6">
                <input type="hidden" id="form-id">
                
                <div>
                    <label for="form-간단내용" class="block text-sm font-medium text-gray-700">간단내용 (제목)</label>
                    <input type="text" id="form-간단내용" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 p-2.5 bg-gray-50 focus:bg-white" required>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="form-대분류" class="block text-sm font-medium text-gray-700">대분류</label>
                        <input list="category-list" id="form-대분류" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 p-2.5 bg-gray-50 focus:bg-white">
                        <datalist id="category-list">
                            <option value="점심"><option value="저녁"><option value="봉사활동"><option value="회사행사"><option value="휴가"><option value="회의"><option value="기타이벤트">
                        </datalist>
                    </div>
                    <div>
                        <label for="form-중요도" class="block text-sm font-medium text-gray-700">중요도</label>
                        <input list="priority-list" id="form-중요도" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 p-2.5 bg-gray-50 focus:bg-white">
                        <datalist id="priority-list">
                            <option value="5"><option value="4"><option value="3"><option value="2"><option value="1"><option value="0">
                        </datalist>
                    </div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div>
                        <label for="form-현황" class="block text-sm font-medium text-gray-700">현황</label>
                        <select id="form-현황" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 p-2.5 bg-gray-50 focus:bg-white">
                            <option value="준비중">준비중</option>
                            <option value="진행중">진행중</option>
                            <option value="완료">완료</option>
                        </select>
                    </div>
                     <div>
                        <label for="form-급한업무" class="block text-sm font-medium text-gray-700">급한업무</label>
                        <input type="text" id="form-급한업무" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 p-2.5 bg-gray-50 focus:bg-white">
                    </div>
                     <div>
                        <label for="form-관련자" class="block text-sm font-medium text-gray-700">관련자</label>
                        <input type="text" id="form-관련자" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 p-2.5 bg-gray-50 focus:bg-white">
                    </div>
                 </div>
                
                <div>
                    <label for="form-세부내용" class="block text-sm font-medium text-gray-700">세부내용</label>
                    <textarea id="form-세부내용" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 p-2.5 bg-gray-50 focus:bg-white"></textarea>
                </div>
                
                <div id="repeat-options-container">
                    <label class="block text-sm font-medium text-gray-700">반복 설정</label>
                    <div class="mt-2 flex items-center space-x-4 p-3 bg-gray-50 rounded-md">
                        <label class="flex items-center"><input type="radio" name="repeat" value="none" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked> <span class="ml-2">안함</span></label>
                        <label class="flex items-center"><input type="radio" name="repeat" value="weekly" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-2">요일반복</span></label>
                        <label class="flex items-center"><input type="radio" name="repeat" value="monthly" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-2">월반복</span></label>
                        <label class="flex items-center"><input type="radio" name="repeat" value="yearly" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-2">연반복</span></label>
                    </div>
                </div>

                <div class="hidden">
                    <label for="form-등록일자" class="block text-sm font-medium text-gray-700">등록일자</label>
                    <input type="date" id="form-등록일자" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 p-2.5 bg-gray-50 focus:bg-white">
                </div>
                <div>
                    <label for="form-마감일자" class="block text-sm font-medium text-gray-700">마감일자</label>
                    <input type="date" id="form-마감일자" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 p-2.5 bg-gray-50 focus:bg-white">
                </div>

                <div class="pt-6 flex justify-end space-x-4">
                    <button type="button" id="deleteBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition-all duration-300 shadow hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 hidden">삭제</button>
                    <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg transition-all duration-300 shadow hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">저장</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-gray-800 bg-opacity-60 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">삭제 확인</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="confirmMessage">정말 삭제하시겠습니까?</p>
                </div>
                <div class="items-center px-4 py-3 space-x-4">
                    <button id="confirmCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none">취소</button>
                    <button id="confirmOkBtn" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none">삭제</button>
                </div>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    // !! IMPORTANT: REPLACE WITH YOUR GOOGLE APPS SCRIPT WEB APP URL !!
    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby6toG28NuPV_tQFoK7UeIE80H5_VJiguNPEcjx51upIgHaHUmDlzC90LkiHwo_ZnGe/exec";

    const loader = document.getElementById('loader');
    const calendarTab = document.getElementById('calendarTab');
    const statusTab = document.getElementById('statusTab');
    const calendarView = document.getElementById('calendarView');
    const statusView = document.getElementById('statusView');
    const yearSelect = document.getElementById('yearSelect');
    const monthSelect = document.getElementById('monthSelect');
    const calendarContainers = [
        document.getElementById('calendarContainer1'),
        document.getElementById('calendarContainer2'),
        document.getElementById('calendarContainer3')
    ];
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const addNewBtn = document.getElementById('addNewBtn');
    const formModal = document.getElementById('formModal');
    const closeModalBtn = document.getElementById('closeModal');
    const todoForm = document.getElementById('todoForm');
    const dataTableBody = document.querySelector('#dataTable tbody');
    const dataTableHeader = document.querySelector('#dataTable thead tr');
    const categoryFilterContainer = document.getElementById('categoryFilterContainer');
    const priorityFilterContainer = document.getElementById('priorityFilterContainer');
    const monthFilterContainer = document.getElementById('monthFilterContainer');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const calendarRepeatFilterContainer = document.getElementById('calendarRepeatFilterContainer');
    const statusRepeatFilterContainer = document.getElementById('statusRepeatFilterContainer');
    const repeatOptionsContainer = document.getElementById('repeat-options-container');

    const confirmModal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmOkBtn = document.getElementById('confirmOkBtn');
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');
    let confirmCallback = null;

    let allData = [];
    let headers = [];
    let currentDate = new Date();
    let sortState = { column: '등록일자', order: 'desc' };
    let savedMonthFilters = JSON.parse(localStorage.getItem('todoMonthFilters')) || {};
    const tableColumnOrder = ['선택', '마감일자', '간단내용', '대분류', '중요도', '급한업무', '세부내용', '등록일자', '현황', '관련자'];
    
    const holidays = {
        '2024': { '01-01': '신정', '02-09': '설날 연휴', '02-10': '설날', '02-11': '설날 연휴', '02-12': '대체공휴일(설날)', '03-01': '삼일절', '04-10': '국회의원 선거', '05-01': '근로자의 날', '05-05': '어린이날', '05-06': '대체공휴일(어린이날)', '05-15': '부처님오신날', '06-06': '현충일', '08-15': '광복절', '09-16': '추석 연휴', '09-17': '추석', '09-18': '추석 연휴', '10-03': '개천절', '10-09': '한글날', '12-25': '크리스마스' },
        '2025': { '01-01': '신정', '01-28': '설날 연휴', '01-29': '설날', '01-30': '설날 연휴', '03-01': '삼일절', '05-01': '근로자의 날', '05-05': '부처님오신날', '05-06': '대체공휴일(부처님오신날)', '06-06': '현충일', '08-15': '광복절', '10-03': '개천절', '10-05': '추석 연휴', '10-06': '추석', '10-07': '추석 연휴', '10-08': '대체공휴일(추석)', '10-09': '한글날', '12-25': '크리스마스' },
    };

    const showLoader = (show) => {
        loader.style.display = show ? 'block' : 'none';
    };

    const fetchData = async () => {
        showLoader(true);
        try {
            const response = await fetch(SCRIPT_URL);
            const result = await response.json();
            if (result.status === 'success') {
                headers = result.headers;
                // Data cleansing for consistent filtering
                allData = result.data.map(item => {
                    if (item.중요도 === null || typeof item.중요도 === 'undefined') {
                        item.중요도 = '';
                    }
                    if (item.반복설정 === null || typeof item.반복설정 === 'undefined') {
                        item.반복설정 = '';
                    }
                    return item;
                });
                initialize();
            } else {
                console.error('Data loading failed:', result.message);
            }
        } catch (error) {
            console.error('Error fetching data:', error);
        } finally {
            showLoader(false);
        }
    };
    
    const postData = async (data) => {
        showLoader(true);
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {'Content-Type': 'text/plain;charset=utf-8'},
                body: JSON.stringify(data),
            });
            await fetchData(); 
        } catch (error) {
            console.error('Error posting data:', error);
        } finally {
            showLoader(false);
        }
    };

    const initialize = () => {
        setupSelectors();
        setupFilters();
        renderMultiCalendar();
        renderTable();
        setupTableHeaders();
    };

    const setupSelectors = () => {
        const currentYear = new Date().getFullYear();
        yearSelect.innerHTML = '';
        for (let i = currentYear - 5; i <= currentYear + 5; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `${i}년`;
            yearSelect.appendChild(option);
        }
        yearSelect.value = currentDate.getFullYear();
        monthSelect.value = currentDate.getMonth() + 1;

        yearSelect.addEventListener('change', renderMultiCalendar);
        monthSelect.addEventListener('change', renderMultiCalendar);
    };

    const setupFilters = () => {
        const categories = [...new Set(allData.map(item => item.대분류).filter(Boolean))];
        const priorities = [...new Set(allData.map(item => String(item.중요도)))].filter(p => p !== '').sort((a,b) => b-a);
        const allMonths = [...new Set(allData.map(item => (item.등록일자 || '').substring(0, 7)))].sort().reverse();
        
        const repeatFilterHTML = `
            <label class="inline-flex items-center"><input type="checkbox" class="repeat-filter form-checkbox" value="none" checked><span class="ml-2">일반</span></label>
            <label class="inline-flex items-center"><input type="checkbox" class="repeat-filter form-checkbox" value="weekly" checked><span class="ml-2">요일반복</span></label>
            <label class="inline-flex items-center"><input type="checkbox" class="repeat-filter form-checkbox" value="monthly" checked><span class="ml-2">월반복</span></label>
            <label class="inline-flex items-center"><input type="checkbox" class="repeat-filter form-checkbox" value="yearly" checked><span class="ml-2">연반복</span></label>
        `;
        calendarRepeatFilterContainer.innerHTML = repeatFilterHTML;
        statusRepeatFilterContainer.innerHTML = repeatFilterHTML;

        categoryFilterContainer.innerHTML = categories.map(cat => `
            <label class="inline-flex items-center"><input type="checkbox" class="category-filter form-checkbox" value="${cat}" checked><span class="ml-2">${cat}</span></label>
        `).join('');

        priorityFilterContainer.innerHTML = priorities.map(prio => `
             <label class="inline-flex items-center"><input type="checkbox" class="priority-filter form-checkbox" value="${prio}" checked><span class="ml-2">${prio}</span></label>
        `).join('') + `
            <label class="inline-flex items-center"><input type="checkbox" class="priority-filter form-checkbox" value="" checked><span class="ml-2 italic">미지정</span></label>
        `;

        monthFilterContainer.innerHTML = allMonths.map(month => `
            <label class="inline-flex items-center"><input type="checkbox" class="month-filter form-checkbox" value="${month}" ${savedMonthFilters[month] !== false ? 'checked' : ''}><span class="ml-2">${month}</span></label>
        `).join('');

        document.querySelectorAll('.category-filter, .priority-filter, .date-type-filter, #calendarRepeatFilterContainer .repeat-filter').forEach(el => {
            el.addEventListener('change', renderMultiCalendar);
        });
        document.querySelectorAll('.month-filter, #statusRepeatFilterContainer .repeat-filter').forEach(el => {
            el.addEventListener('change', (e) => {
                if(e.target.classList.contains('month-filter')) {
                    savedMonthFilters[e.target.value] = e.target.checked;
                    localStorage.setItem('todoMonthFilters', JSON.stringify(savedMonthFilters));
                }
                renderTable();
            });
        });
    };

    const renderMultiCalendar = () => {
        const year = parseInt(yearSelect.value);
        const month = parseInt(monthSelect.value) - 1;
        currentDate = new Date(year, month, 1);

        const dates = [ new Date(year, month, 1), new Date(year, month + 1, 1), new Date(year, month + 2, 1) ];
        calendarContainers.forEach((container, index) => {
            renderSingleMonth(container, dates[index], allData);
        });
    };

    const renderSingleMonth = (container, date, data) => {
        const titleEl = container.querySelector('.calendar-title-text');
        const gridEl = container.querySelector('.calendar-grid');
        gridEl.innerHTML = '';

        const year = date.getFullYear();
        const month = date.getMonth();
        titleEl.textContent = `${year}년 ${month + 1}월`;

        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);

        const selectedDateType = document.querySelector('input[name="dateType"]:checked').value;
        const selectedCategories = [...document.querySelectorAll('.category-filter:checked')].map(el => el.value);
        const selectedPriorities = [...document.querySelectorAll('.priority-filter:checked')].map(el => el.value);
        const selectedRepeats = [...document.querySelectorAll('#calendarRepeatFilterContainer .repeat-filter:checked')].map(el => el.value);


        const monthData = data.filter(item => {
            const dateStr = item[selectedDateType];
            if (!dateStr) return false;
            const itemDate = new Date(dateStr);
            return itemDate.getFullYear() === year && 
                   itemDate.getMonth() === month &&
                   selectedCategories.includes(item.대분류) &&
                   selectedPriorities.includes(String(item.중요도)) &&
                   selectedRepeats.includes(item.반복설정 || 'none');
        });

        for (let i = 0; i < firstDayOfMonth.getDay(); i++) {
            gridEl.insertAdjacentHTML('beforeend', '<div class="calendar-day p-1 bg-white"></div>');
        }

        for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
            const dayCell = document.createElement('div');
            const dayDate = new Date(year, month, i);
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const holidayKey = `${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            
            dayCell.className = 'calendar-day p-1 bg-white relative';
            dayCell.dataset.date = dateString;

            const eventsForDay = monthData.filter(item => new Date(item[selectedDateType]).getDate() === i);
            
            const dayOfWeek = dayDate.getDay();
            const isHoliday = holidays[year]?.[holidayKey];
            const hasVacation = eventsForDay.some(event => event.대분류 === '휴가');
            if (dayOfWeek === 0 || dayOfWeek === 6 || isHoliday || hasVacation) {
                dayCell.classList.add('is-resting-day');
            }
            
            const dayNumber = document.createElement('span');
            dayNumber.textContent = i;
            if (dayOfWeek === 0 || isHoliday) dayNumber.classList.add('text-red-500');
            if (dayOfWeek === 6) dayNumber.classList.add('text-blue-500');

            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) {
                dayNumber.classList.add('bg-indigo-500', 'text-white', 'rounded-full', 'w-5', 'h-5', 'flex', 'items-center', 'justify-center', 'font-bold');
            }
            dayCell.appendChild(dayNumber);
            
            if (isHoliday) {
                const holidayEl = document.createElement('div');
                holidayEl.textContent = holidays[year][holidayKey];
                holidayEl.className = 'holiday-text';
                dayCell.appendChild(holidayEl);
            }
            
            dayCell.addEventListener('click', () => openModalForNew(dayCell.dataset.date));

            eventsForDay.forEach(event => {
                const eventEl = document.createElement('div');
                eventEl.textContent = event.간단내용;
                eventEl.className = `event event-${event.대분류} cursor-pointer`;
                eventEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openModalForEdit(event);
                });
                dayCell.appendChild(eventEl);
            });
            gridEl.appendChild(dayCell);
        }
    };
    
    prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        yearSelect.value = currentDate.getFullYear();
        monthSelect.value = currentDate.getMonth() + 1;
        renderMultiCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        yearSelect.value = currentDate.getFullYear();
        monthSelect.value = currentDate.getMonth() + 1;
        renderMultiCalendar();
    });

    const setupTableHeaders = () => {
        dataTableHeader.innerHTML = '';
        tableColumnOrder.forEach(header => {
            if (header === '선택') {
                 const selectTh = document.createElement('th');
                selectTh.className = 'py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b';
                selectTh.textContent = '선택';
                dataTableHeader.appendChild(selectTh);
            } else if (headers.includes(header)) {
                const th = document.createElement('th');
                th.className = 'py-3 px-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b';
                th.textContent = header;
                th.dataset.column = header;
                th.addEventListener('click', () => {
                    const column = th.dataset.column;
                    const order = sortState.column === column && sortState.order === 'asc' ? 'desc' : 'asc';
                    sortState = { column, order };
                    renderTable();
                });
                dataTableHeader.appendChild(th);
            }
        });
    };
    
    const renderTable = () => {
        dataTableBody.innerHTML = '';
        const activeMonthFilters = [...document.querySelectorAll('.month-filter:checked')].map(el => el.value);
        const selectedRepeats = [...document.querySelectorAll('#statusRepeatFilterContainer .repeat-filter:checked')].map(el => el.value);

        const filtered = allData.filter(item => {
             const itemMonth = (item.등록일자 || '').substring(0, 7);
             return activeMonthFilters.includes(itemMonth) && selectedRepeats.includes(item.반복설정 || 'none');
        });
        const sorted = [...filtered].sort((a, b) => {
            const valA = a[sortState.column] || '';
            const valB = b[sortState.column] || '';
            if (valA < valB) return sortState.order === 'asc' ? -1 : 1;
            if (valA > valB) return sortState.order === 'asc' ? 1 : -1;
            return 0;
        });
        
        sorted.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';
            row.dataset.id = item.id;
            
            tableColumnOrder.forEach(header => {
                if (header === '선택') {
                    const selectCell = document.createElement('td');
                    selectCell.className = 'py-3 px-4 text-center';
                    selectCell.innerHTML = `<input type="checkbox" class="row-checkbox h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">`;
                    row.appendChild(selectCell);
                } else if (headers.includes(header)) {
                    const cell = document.createElement('td');
                    cell.className = 'py-3 px-4 text-sm text-gray-700';
                    if (header !== '간단내용' && header !== '세부내용') {
                        cell.classList.add('whitespace-nowrap');
                    }
                    cell.textContent = item[header] || '';
                    cell.dataset.column = header;
                    cell.setAttribute('contenteditable', 'true');
                    cell.addEventListener('blur', (e) => {
                        const newValue = e.target.textContent;
                        if(item[header] !== newValue) {
                            item[header] = newValue;
                            postData({ action: 'update', rowData: item });
                        }
                    });
                    row.appendChild(cell);
                }
            });
            dataTableBody.appendChild(row);
        });
    };

    const openModalForNew = (date) => {
        todoForm.reset();
        document.getElementById('form-id').value = '';
        deleteBtn.style.display = 'none';
        repeatOptionsContainer.style.display = 'block';
        const today = date ? new Date(date) : new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('form-등록일자').value = `${yyyy}-${mm}-${dd}`;
        formModal.style.display = 'block';
    };

    const openModalForEdit = (item) => {
        todoForm.reset();
        document.getElementById('form-id').value = item.id;
        deleteBtn.style.display = 'block';
        repeatOptionsContainer.style.display = 'none'; // Hide repeat options on edit
        for (const key in item) {
            const input = document.getElementById(`form-${key}`);
            if (input) {
                if (input.type === 'date') {
                     input.value = item[key] ? item[key].split('T')[0] : '';
                } else {
                     input.value = item[key];
                }
            }
        }
        formModal.style.display = 'block';
    };

    const closeModal = () => {
        formModal.style.display = 'none';
    };
    
    closeModalBtn.addEventListener('click', closeModal);
    addNewBtn.addEventListener('click', () => openModalForNew(null));
    formModal.addEventListener('click', (e) => {
        if(e.target === formModal) closeModal();
    });

    todoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const rowData = {};
        headers.forEach(header => {
            const input = document.getElementById(`form-${header}`);
            if (input) rowData[header] = input.value;
        });
        
        const action = document.getElementById('form-id').value ? 'update' : 'create';
        const repeatType = document.querySelector('input[name="repeat"]:checked').value;
        if (action === 'update') {
            rowData.id = document.getElementById('form-id').value;
        }

        await postData({ 
            action, 
            rowData,
            repeatType: (action === 'create' ? repeatType : 'none') 
        });
        closeModal();
    });

    function showConfirm(message, callback) {
        confirmMessage.textContent = message;
        confirmCallback = callback;
        confirmModal.style.display = 'block';
    }

    confirmOkBtn.addEventListener('click', () => {
        if (confirmCallback) confirmCallback();
        confirmModal.style.display = 'none';
    });

    confirmCancelBtn.addEventListener('click', () => {
        confirmModal.style.display = 'none';
    });
    
    deleteSelectedBtn.addEventListener('click', () => {
        const checkedRows = document.querySelectorAll('#dataTable tbody .row-checkbox:checked');
        const idsToDelete = [...checkedRows].map(cb => cb.closest('tr').dataset.id);

        if (idsToDelete.length === 0) return;

        showConfirm(`${idsToDelete.length}개의 항목을 정말 삭제하시겠습니까?`, async () => {
            await postData({ action: 'delete', ids: idsToDelete });
        });
    });

    deleteBtn.addEventListener('click', () => {
        const idToDelete = document.getElementById('form-id').value;
        if (idToDelete) {
            showConfirm('이 일정을 정말 삭제하시겠습니까?', async () => {
                await postData({ action: 'delete', ids: [idToDelete] });
                closeModal();
            });
        }
    });
    
    calendarTab.addEventListener('click', () => {
        calendarView.style.display = 'block';
        statusView.style.display = 'none';
        calendarTab.classList.add('tab-active');
        statusTab.classList.remove('tab-active');
    });

    statusTab.addEventListener('click', () => {
        calendarView.style.display = 'none';
        statusView.style.display = 'block';
        statusTab.classList.add('tab-active');
        calendarTab.classList.remove('tab-active');
    });

    if (SCRIPT_URL === "YOUR_GOOGLE_APPS_SCRIPT_URL" || !SCRIPT_URL) {
        if(document.body) {
          document.body.innerHTML = '<div style="padding: 2rem; text-align: center; font-size: 1.2rem; color: red;">중요: index.html 파일의 SCRIPT_URL을 본인의 Google Apps Script URL로 교체해주세요.</div>';
        }
        showLoader(false);
    } else {
        fetchData();
    }
});
</script>

</body>
</html>

